<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>{{globals().get('page_name') or '聚类校对'}}</title>
  {% include com/_base_css.html %}
  <link href="{{static_url('css/box.css')}}" rel="stylesheet"/>
  <link href="{{static_url('css/cluster.css')}}" rel="stylesheet">
  <link href="{{static_url('css/char-txt.css')}}" rel="stylesheet">
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->
  <style>
    #panel-region {
      width: 260px;
      max-width: 260px;
    }

    .add-gap li:first-child {
      margin-top: 18px;
    }
  </style>
</head>

<body class="widescreen">
<div class="app-main">
  <div class="main">
    <div class="m-header">
      <div class="left">
        <div class="btn-group back">
          <span class="icon-return-back" onclick="leave()" data-toggle="tooltip" data-placement="bottom" title="返回"></span>
        </div>
        <div class="btn-group title">
          {{globals().get('page_name') or '聚类校对'}}
        </div>
      </div><!--left-->
      <div class="center">
        <div id="help" class="btn-txt icon-help" data-toggle="tooltip" data-placement="bottom" title="帮助"></div>
        <div class="btn-group" data-toggle="tooltip" data-placement="bottom" title="按置信度过滤">
          <i class="btn-txt icon-filter dropdown-toggle" data-toggle="dropdown"></i>
          <div class="dropdown-menu filter-menu" data-stopPropagation="true">
            <div class="menu-title">按置信度过滤</div>
            <li class="divider"></li>
            <div class="input-line">
              <input id="filter-start" type="text" class="form-control input-sm" placeholder="起始值">
              <span>~</span>
              <input id="filter-end" type="text" class="form-control input-sm" placeholder="终止值">
            </div>
            <button id="btn-filter" type="button" class="btn btn-primary btn-sm">确定</button>
          </div>
        </div>
        <div class="btn-group add-gap" data-toggle="tooltip" data-placement="bottom" title="按置信度排序">
          <i class="btn-txt icon-sort dropdown-toggle" data-toggle="dropdown"></i>
          <ul class="dropdown-menu" data-stopPropagation="true">
            <li><a id="btn-cc-up">按置信度升序</a></li>
            <li><a id="btn-cc-down">按置信度降序</a></li>
            <li class="divider hide"></li>
            <li><a id="btn-lc-up" class="hide">按列置信度升序</a></li>
            <li><a id="btn-lc-down" class="hide">按列置信度降序</a></li>
          </ul>
        </div>
        <div class="btn-group add-gap" data-toggle="tooltip" data-placement="bottom" title="按系统建议标记过滤">
          <i class="btn-txt icon-ai dropdown-toggle" data-toggle="dropdown"></i>
          <ul class="dropdown-menu" data-stopPropagation="true">
            <li><a id="btn-un-diff">一致</a></li>
            <li><a id="btn-diff">不一致</a></li>
            <li class="divider"></li>
            <li><a id="btn-required">需要校对</a></li>
            <li><a id="btn-un-required">不必校对</a></li>
          </ul>
        </div>
        <div class="btn-group add-gap" data-toggle="tooltip" data-placement="bottom" title="按人工校对标记过滤">
          <i class="btn-txt icon-man dropdown-toggle" data-toggle="dropdown"></i>
          <ul class="dropdown-menu" data-stopPropagation="true">
            <li><a id="btn-vague">笔画残损</a></li>
            <li><a id="btn-un-vague">笔画完整</a></li>
            <li class="divider"></li>
            <li><a id="btn-deform">异形字</a></li>
            <li><a id="btn-un-deform">非异形字</a></li>
            <li class="divider"></li>
            <li><a id="btn-certain">确定</a></li>
            <li><a id="btn-uncertain">不确定</a></li>
            <li class="divider"></li>
            <li><a id="btn-has-remark">有备注</a></li>
            <li><a id="btn-no-remark">无备注</a></li>
          </ul>
        </div>
        <div class="btn-group add-gap" data-toggle="tooltip" data-placement="bottom" title="按提交、修改过滤">
          <i class="btn-txt icon-submit1 dropdown-toggle" data-toggle="dropdown"></i>
          <ul class="dropdown-menu" data-stopPropagation="true">
            <li><a id="btn-un-submitted">未提交</a></li>
            <li><a id="btn-submitted">已提交</a></li>
            <li class="divider"></li>
            <li><a id="btn-un-updated">未修改</a></li>
            <li><a id="btn-updated">已修改</a></li>
            <li><a id="btn-my-updated">我的修改</a></li>
            <li><a id="btn-other-updated">其它修改</a></li>
          </ul>
        </div>
        <div id="btn-multi" class="btn-txt icon-all-select" data-toggle="tooltip" data-placement="bottom" title="多选模式"></div>
        <div id="bat-select" class="btn-txt icon-all-select1" data-toggle="tooltip" data-placement="bottom" title="全部选择"></div>
        <div id="bat-update" class="btn-txt icon-pencil" data-toggle="tooltip" data-placement="bottom" title="批量修改"></div>
        <div class="search hide">
          <input id="search-variant" type="text" placeholder="搜索异体字字典">
          <i id="icon-search" class="icon-search"></i>
        </div>
      </div><!--center-->
      <div class="right">
        {% set mode = globals().get('mode') or '' %}
        {% set readonly = globals().get('readonly') or False %}
        {% set my_task = globals().get('mode') in ['do', 'update', 'nav'] %}
        <div id="toggle-column-panel" class="btn-txt icon-panel-txt active" data-toggle="tooltip" data-placement="bottom" title="显隐中间列图"></div>
        <div id="toggle-proof-panel" class="btn-txt icon-right-panel active" data-toggle="tooltip" data-placement="bottom" title="显隐校对面板"></div>
        <div id="task-my-remark" class="btn-txt icon-edit2{{' hide' if not my_task else ''}}" data-toggle="tooltip" data-placement="bottom" title="备注我的任务"></div>
        <div id="task-admin-remark" class="btn-txt icon-edit{{' hide' if mode != 'browse' else ''}}" data-toggle="tooltip" data-placement="bottom" title="备注任务管理"></div>
        <div id="task-return" class="btn-txt icon-return-task{{' hide' if not my_task else ''}}" data-toggle="tooltip" data-placement="bottom" title="退回任务[ctrl+r]"></div>
        <div id="task-submit-back" class="btn-txt icon-check-outline2 order{{' hide' if readonly or not my_task else ''}}" data-toggle="tooltip" data-placement="bottom" title="提交后转任务大厅[y]"></div>
        <div id="task-submit" class="btn-txt icon-submit my-task order{{' hide' if readonly or not my_task else ''}}" data-toggle="tooltip" data-placement="bottom" title="提交后领新任务[t]"></div>
        <div id="task-prev" class="btn-txt icon-arrow-left {{'hide' if mode not in ['browse', 'nav'] else mode}}" data-toggle="tooltip" data-placement="bottom" title="前一个任务[]]"></div>
        <div id="task-next" class="btn-txt icon-arrow-right {{'hide' if mode not in ['browse', 'nav'] else mode}}" data-toggle="tooltip" data-placement="bottom" title="后一个任务[[]"></div>
      </div><!--right-->
    </div><!--m-header-->

    <div class="m-body flex">
      <div class="char-panel">
        <div class="txt-kinds slim-bar"></div>
        <div class="variants slim-bar"></div>
        <div class="char-items slim-bar"></div>
        {% module Pager(pager) %}
      </div><!--char-panel-->
      <div class="column-panel">
        <div class="box-holder slim-bar"></div>
        <div class="btn-group">
          <div id="zoom-in" class="btn-txt icon-zoom-in" title="放大图片[+]"></div>
          <div id="submit-box" class="btn-txt icon-save" title="保存修改[ctrl+s]"></div>
          <div id="zoom-out" class="btn-txt icon-zoom-out" title="缩小图片[-]"></div>
        </div>
      </div><!--column-panel-->
      <div id="panel-region" class="right bd proof-panel">
        {% include com/_char_txt.html %}
      </div><!--char-panel-->
    </div><!--m-body-->

    <div class="m-alert alert alert-info hide" id="m-alert">
      <a class="close">×</a><i class="loading icon-spinner1 animate-spin"></i>
      <strong class="title"></strong><span class="text"></span>
    </div><!--m-alert-->

    <div class="m-footer">
      <span class="fl">
        <span class="cluster-info">
          总字数：<span class="char-count">{{char_count}}</span>
          聚类字种：<span class="txt-kinds">{{'、'.join(base_txts)}}</span>
        </span>
      </span>
      <span class="center">
      </span>
      <span class="fr">
        <span class="page-info" style="margin-right: 15px">页编码：<span class="page-name"></span></span>
        <span class="char-info">字编码：<span class="char-name">未选中</span></span>
      </span>
    </div><!--m-footer-->
  </div>
</div>

<div class="panel-body" style="padding: 0">
  <div id="helpModal" class="modal help fade" tabindex="-1" role="dialog" aria-labelledby="helpModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          <h4 class="modal-title">帮助文档<a class="more-help" href="/article/help-cluster">更多</a></h4>
        </div>
        <div class="modal-body">
          <div class="title">一、简单介绍</div>
          <div class="intro">
            聚类校对是一种将OCR识别出的文字按照字种聚集到一起进行批量处理的校对方式。一个聚类校对任务的字头显示在左上方，
            字头区域下是式当前字头所有的异体字列表。左下方区域是当前字头的所有字图。用户需要检查字图中的图片字形与当前的
            字头文字是否相一致，如果不一致，就需要在右侧的校对工作区输入正确的文字。
          </div>
          <div class="title">二、一般步骤</div>
          <div class="intro">
            1. 逐一点击左上区域的字头（当前字头将会高亮显示）<br/>
            2. 检查该字头下字图区域的字图，如果发现字图中的文字与当前字头不一致，则进行修改：<br/>
            （1）右侧工作面板可以查看该字的OCR候选字，选择某字后该字会出现在校对工作区的输入位置；<br/>
            （2）左侧字头下有该字头的异体字列表，选择某字后该字会出现在校对工作区的输入位置；<br/>
            （3）如果没有合适的文字可供选择，可以手工输入正确的校对文字到工作区输入位置；<br/>
            （4）输入后确认，该字图中的文字信息即被修改为输入的文字<br/>
            3. 如果发现当前页所有字图都没有错误，则可以提交当前页<br/>
            4. 如果所有页面都已经提交，则可以提交当前任务<br/>
            注：为提高校对效率，系统提供了条件筛选、批量修改等校对辅助功能。
          </div>
          <div class="title">三、按钮说明</div>
          <table class="table">
            <tr>
              <td><i class="icon-sort"></i></td>
              <td>待校对的字图按置信度升序排列或按置信度降序排列</td>
            </tr>
            <tr>
              <td><i class="icon-cc"></i></td>
              <td>按置信度过滤。输入正确范围的数值（0-1），点击最左侧空白方框取消过滤</td>
            </tr>
            <tr>
              <td><i class="icon-filter"></i></td>
              <td>按照条件过滤来选择字图。<br/>
                过滤条件包括：异文，已提交，未提交，我的修改，所有修改。<br/>
                根据不同的过滤条件显示字图。 选择一个过滤条件后，再选择一个条件，结果是两个条件的叠加。
                如：已提交/未提交 + 我的修改/所有修改，异文可以和任意一个其他条件组合。<br/>
                如果两个条件不相容，则后面的覆盖前面的条件，例如：先选未提交，再选已提交，结果是已经提交的。<br/>
                点击最左侧的空白方框取消过滤，显示所有字图。
              </td>
            </tr>
            <tr>
              <td><i class="icon-checkbox2"></i></td>
              <td>将本页字图区显示的字图全部选择，注意不会选择不在本页显示的字图</td>
            </tr>
            <tr>
              <td><i class="icon-pencil"></i></td>
              <td>将选中的字图批量修改为正确的字</td>
            </tr>
            <tr>
              <td><i class="icon-edit1"></i></td>
              <td>将选中的字图的类型（没问题、模糊或残损、不确定、不认识）进行批量修改</td>
            </tr>
            <tr>
              <td><i class="icon-panel-txt"></i></td>
              <td>显隐中间的原始图片列</td>
            </tr>
            <tr>
              <td><i class="icon-right-panel"></i></td>
              <td>显隐右侧工作面板</td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div id="variantModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="variantModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content modal-sm">
        <div class="modal-header"><h4 class="modal-title">新增图片字</h4></div>
        <div class="modal-body">
          <form class="form-horizontal">
            <div class="form-group">
              <h4 class="col-sm-3 control-label">图片字</h4>
              <div class="col-sm-8">
                <input type="text" class="form-control txt" placeholder="请输入图片字的编码">
                <div style="font-style: italic; color: grey">注：默认选择当前图片编码，您可以自行修改</div>
              </div>
              <h4 class="col-sm-3 control-label hide" style="margin-top: 10px">所属正字</h4>
              <div class="col-sm-8 hide" style="margin-top: 10px">
                <input type="text" class="form-control nor-txt" placeholder="请输入所属正字" readonly="readonly">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">确定</button>
        </div>
      </div>
    </div>
  </div>
  <div id="resultModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="resultModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h4 class="modal-title">更新结果</h4></div>
        <div class="modal-body">
          <form class="form-horizontal">
            <div class="form-group">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <div class="col-sm-12" style="font-style: italic;margin-bottom: 8px;">注：点击确定将刷新页面，可查看更新后的结果，取消则保持页面。</div>
          <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary waves-effect waves-light modal-confirm">确定</button>
        </div>
      </div>
    </div>
  </div>
  {% if hasattr(handler, 'task_type') and handler.task_type %}
  {% module ReturnModal() %}
  {% module TaskRemarkModal() %}
  {% module TaskConfigModal(handler.config_fields if hasattr(handler, 'config_fields') else []) %}
  {% end %}
</div>

{% include com/_base_js.html %}
<script src="{{static_url('js/box/jquery.mapKey.js')}}"></script>
<script src="{{static_url('js/box/raphael.js')}}"></script>
<script src="{{static_url('js/box/raphael.zoom.js')}}"></script>
<script src="{{static_url('js/box/box.base.js')}}"></script>
<script src="{{static_url('js/box/box.cut.js')}}"></script>
<script src="{{static_url('js/box/box.key.js')}}"></script>
<script src="{{static_url('js/char-txt.js')}}"></script>
<script src="{{static_url('js/cluster.js')}}"></script>
<script src="{{static_url('js/btn-cluster.js')}}"></script>
{% include com/_base_task.html %}
<script>
  $.charTxt.init({readonly: false, showBase: false, showTxtLogs: true, showBoxLogs: true});
  $.cluster.init({
    curTxt: '{{cur_txt}}',
    colHolder: '.box-holder',
    chars: decodeJSON('{{chars}}'),
    variants: decodeJSON('{{variants}}'),
    txtKinds: decodeJSON('{{txt_kinds}}'),
  });

  $(document).ready(function () {
    getAnchor() ? $('#' + getAnchor()).find('.char-img').click() : $('.char-img:first').click();
  });


  // 初始化
  $('#taskConfigModal .page-size').val('{{handler.page_size}}');
  if (!getStorage('toggle-column-panel', true)) {
    $('#toggle-column-panel').removeClass('active');
    $('.column-panel').addClass('hide');
  }
  if (!getStorage('toggle-work-panel', true)) {
    $('#toggle-work-panel').removeClass('active');
    $('.work-panel').addClass('hide');
  }

  // 配置项
  $('#taskConfigModal .modal-confirm').on('click', function () {
    let data = {};
    let pageSize = $('#taskConfigModal .page-size').val();
    if (pageSize.length) {
      if (!/^\d+$/.test(pageSize)) {
        return showTips('提示', '每页条数中请输入数字', 3000);
      } else if (parseInt(pageSize) > 100) {
        return showTips('提示', '每页条数不能超过100', 3000);
      } else {
        data['cluster_page_size'] = pageSize;
      }
    }
    let showCharInfo = $('#taskConfigModal .show-char-info :checked');
    if (showCharInfo) {
      data['cluster_char_info'] = showCharInfo.val();
      $('.char-info, .cc').toggleClass('hide', showCharInfo.val() !== '是');
    }
    if (JSON.stringify(data) !== '{}') {
      $(this).text('进行中...');
      postApi('/session/config', {data: data}, function () {
        location.reload();
      });
    }
  });

  // 新增异体字
  $('#add-variant').on('click', function () {
    let normalTxt = $('.txt-kind.current').attr('data-value'), currentName = $('.char-name').text();
    $('#variantModal .nor-txt').val(normalTxt);
    $('#variantModal .txt').val(currentName);
    $('#variantModal').modal();
  });
  $('#variantModal .modal-confirm').on('click', function () {
    let data = {txt: $('#variantModal .txt').val(), nor_txt: $('#variantModal .nor-txt').val()};
    if (!data.txt.length) {
      return showTips('提示', '请输入异体字文字或字图编码', 3000);
    } else if (!data.nor_txt.length) {
      return showTips('提示', '请输入异体字所属正字', 3000);
    } else {
      $(this).text('进行中...');
      postApi('/data/variant', {data: data}, function (res) {
        $("#variantModal").modal('hide');
        if (/[0-9a-zA-Z_]+/.test(data.txt)) {
          let imgUrl = $('#' + data.txt).find('img').attr('src');
          $('.variants').append(`<span class="variant variant-img txt-item" data-value="Y${res.doc.uid}"><img src="${imgUrl}"/></span>`);
        } else {
          $('.variants').append(`<span class="variant txt-item" data-value="${data.txt}">${data.txt}</span>`);
        }
      });
    }
  });

  // 删除异体字
  $(document).on('dblclick', '.variant-img', function () {
    let $this = $(this);
    showConfirm('提示', '确定删除该图片字吗？', function () {
      postApi('/variant/delete', {data: {uid: $this.attr('data-value')}}, function (res) {
        $this.remove();
      });
    });
  });

  // 批量修改文字
  $('#bat-update-txt').on('click', function () {
    let names = $.map($('.char-check :checked'), (item) => $(item).attr('title'));
    if (!names.length)
      return showTips('请选择', '当前没有选中任何记录', 3000);
    Swal2.fire({title: '请输入文字', input: 'text', inputValue: $('.proof .txt').val()}).then((result) => {
      if (result.value) {
        let data = {names: names, txt: result.value, task_type: taskType};
        postApi('/chars/txt', {data: data}, function (res) {
          if (res.data.level_unqualified || res.data.level_unqualified) {
            $('#resultModal .form-group').html($.map(res.data, function (value, key) {
              return `<h4 class="col-sm-3 control-label">${_t(key)}(${value.length})</h4><div class="col-sm-9">${value.join(', ')}</div>`
            }).join(''));
            $('#resultModal').modal();
          } else {
            location.reload();
          }
        });
      }
    });
  });

  // 批量修改类型
  $('#bat-update-type').on('click', function () {
    let names = $.map($('.char-check :checked'), (item) => $(item).attr('title'));
    if (!names.length)
      return showTips('请选择', '当前没有选中任何记录', 3000);
    Swal2.fire({title: '请选择类型', input: 'radio', inputOptions: txtTypes}).then((result) => {
      if (result.value) {
        let data = {names: names, txt_type: result.value, task_type: taskType};
        postApi('/chars/txt_type', {data: data}, function (res) {
          if (res.data.level_unqualified || res.data.level_unqualified) {
            $('#resultModal .form-group').html($.map(res.data, function (value, key) {
              return `<h4 class="col-sm-3 control-label">${_t(key)}(${value.length})</h4><div class="col-sm-9">${value.join(', ')}</div>`
            }).join(''));
            $('#resultModal').modal();
          } else {
            location.reload();
          }
        });
      }
    });
  });

  $('#resultModal .modal-confirm').on('click', function () {
    location.reload();
  });

  // 提交当前页
  $('#page-submit').on("click", function () {
    $('#progress').removeClass('hide');
    let charNames = $.map($('.char-item'), function (item) {
      return $(item).attr('data-id');
    });
    postApi(location.pathname, {data: {char_names: charNames}}, function () {
      $('#progress').addClass('hide');
      $('.char-item .submitted').removeClass('hide');
      showSuccess('成功', '页面已提交。', 2000);
    });
  });

  // 方向键移动
  $.mapKey('left', function () {
    $('.char-item.current').prev().find('.char-img').click();
  });

  // 方向键移动
  $.mapKey('right', function () {
    $('.char-item.current').next().find('.char-img').click();
  });

  // 单字提交
  $('.char-txt .btn-submit').on('click', function () {
    let $this = $(this);
    if ($this.hasClass('disabled')) return;
    let name = $('.char-txt .cur-name').val();
    if (!name.length) return bsShow('', '请选择校对文字', 'warning', 1000, '#s-alert');
    if (!$('#p-txt').val().length) return bsShow('', '请输入校对文本', 'warning', 1000, '#s-alert');
    let data = {
      txt: $('#p-txt').val() || '',
      remark: $('#p-remark').val() || '',
      is_vague: $('.is-vague :checked').val() === '1',
      is_deform: $('.is-deform :checked').val() === '1',
      uncertain: $('.uncertain :checked').val() === '1',
      task_type: typeof gTaskType === 'undefined' ? '' : gTaskType
    };
    $this.addClass('disabled');
    postApi('/char/txt/' + name, {data: data}, function (res) {
      $this.removeClass('disabled');
      location.href = setAnchor(name);
      bsShow('', '已保存成功', 'success', 1000, '#s-alert');
      $('.char-item.current .txt').text(data.txt);
      $.charTxt.setTxtLogs(res['txt_logs']);
    }, function (err) {
      $this.removeClass('disabled');
      if (err.code === 2007) bsShow('', err.message, 'info', 1000, '#s-alert');
      else bsShow('失败', err.message, 'warning', 1000);
    });
  });

</script>
</body>
</html>
